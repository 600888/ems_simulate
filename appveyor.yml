version: '{build}'
image: Ubuntu

environment:
  GITHUB_TOKEN:
    secure: aKZhV0AB4Vw1Bjb+mn/m3/90JiqRldZ23tpa+gu+fnbeELKaciUo/vi/H+TVju7X

# 只在主分支构建
branches:
  only:
    - master
    - main

# 安装依赖
install:
  - nvm install 18
  - nvm use 18
  - npm install -g pnpm
  - cd docs
  - pnpm install

# 构建文档
build_script:
  - pnpm run docs:build

# 部署到 GitHub Pages
deploy_script:
  - git config --global user.email "appveyor@ci.com"
  - git config --global user.name "AppVeyor CI"
  # 克隆 gh-pages 分支或创建新分支
  - git clone --depth 1 --branch gh-pages https://github.com/600888/ems_simulate.git gh-pages 2>/dev/null || mkdir gh-pages
  - cd gh-pages
  - git init 2>/dev/null || true
  - git checkout -b gh-pages 2>/dev/null || true
  # 清空旧内容并复制新构建产物
  - rm -rf *
  - cp -r ../docs/.vitepress/dist/* ./
  # 创建 .nojekyll 文件避免 GitHub Pages 处理
  - touch .nojekyll
  # 提交并推送
  - git add -A
  - git commit -m "Deploy docs - build ${APPVEYOR_BUILD_NUMBER} [skip ci]" || true
  - git push https://${GITHUB_TOKEN}@github.com/600888/ems_simulate.git gh-pages --force

# 缓存 node_modules 加速构建
cache:
  - docs/node_modules -> docs/package.json
